# LinuxTips26--TC1-TC原理

## 参考网址

https://cloud.tencent.com/developer/article/1772836?from=information.detail.linux%20tc%20cbq

## 相关概念

+ 报文分组从输入网卡(入口)接收进来，经过路由的查找， 以确定是发给本机的，还是需要转发的。如果是发给本机的，就直接向上递交给上层的协议，比如TCP，如果是转发的， 则会从输出网卡(出口)发出。

+ **网络流量的控制通常发生在输出网卡处。**

+ 虽然在路由器的入口处也可以进行流量控制，Linux也具有相关的功能， 但一般说来， 由于我们无法控制自己网络之外的设备， 入口处的流量控制相对较难。

+ TC采用如下规定描述带宽

  ```
  mbps = 1024 kpbs = 1024 * 1024 bps => byte/s
  mbit = 1024 kbit => kilo bit/s
  mb = 1024 kb = 1024 * 1024 b => byte
  mbit = 1024 kbit => kilo bit
  内定：数字以 bps 和 b 方式存储，但当 tc 输出速率时，使用如下表示：
  1Mbit = 1024 Kbit = 1024 * 1024 bps => byte/s
  ```
  
  ```
  ◆ Kbps kiIobytes per second， 即”千字节每秒 ;
  
  ◆ Mbps megabytes per second， 即”兆字节每秒 ，
  
  ◆ Kbit kilobits per second，即”千比特每秒 ;
  
  ◆ Mbit megabits per second， 即”兆比特每秒 。
  ```

---

## TC原理介绍

+ 流量控制器**TC（Traffic Control）**用于Linux内核的**流量控制**，主要是通过在输出端口处建立一个队列来实现流量控制。

+ 接收包从**输入接口（Input Interface）**进来后，经过**流量限制（Ingress Policing）**丢弃不符合规定的数据包，由**输入多路分配器（Input De-Multiplexing）**进行判断选择：如果接收包的目的是本主机，那么将该包送给上层处理；否则需要进行转发，将接收包交到**转发块（Forwarding Block）**处理。转发块同时也接收本主机上层（TCP、UDP等）产生的包。转发块通过查看路由表，决定所处理包的下一跳。然后，对包进行排列以便将它们传送到**输出接口（Output Interface）**。

  ![tips26-1](E:\Notes\Linux\tips26-1.jpg)

+ 流量控制的一个基本概念是**队列(Qdisc)**，每个网卡都与一个队列(Qdisc)相联系， 每当内核需要将报文分组从网卡发送出去， 都会首先将该报文分组添加到该网卡所配置的队列中， 由该队列决定报文分组的发送顺序。**可以说，所有的流量控制都发生在队列中**。

+ 队列的功能

  + 有些队列的功能是非常简单的， 它们对报文分组实行先来先走（FIFO）的策略（pfifo_fast队列）

  + 有些队列则功能复杂，会将不同的报文分组进行排队、分类，并根据不同的原则， 以不同的顺序发送队列中的报文分组。

    + 为实现这样的功能，这些复杂的队列需要使用不同的**过滤器(Filter)**来把报文分组分成不同的**类别(Class)**。这里把这些复杂的队列称为**可分类(ClassfuI)的队列**。
+ 通常， 要实现功能强大的流量控制， 可分类的队列是必不可少的。
  
    ![tips26-2](E:\Notes\Linux\tips26-2.jpg)
    

+ 类别（Class）和过滤器（Filter）都是队列的内部结构

### 队列

+ 可分类的队列可以包含多个类别；

+ 一个类别又可以进一步包含有子队列或者子类别

### 过滤器

+ 过滤器是队列用来对数据报文进行分类的工具，它决定一个数据报文将被分配到哪个类别中

+ TC 可以使用的过滤器

  + fwmark 分类器

    fwmark 分类器允许我们使用 Linux netfilter 代码选择流量

  + u32 分类器

    u32 分类器允许我们选择基于 ANY 头的流量

  + 基于路由的分类器

  +  RSVP分类器(分别用于 IPV6、IPV4)等

## TC

+ 对网卡进行流量控制配置的步骤

  + 为网卡配置一个队列
  + 在该队列上建立分类
  + 根据需要建立子队列和子分类
  + 为每个分类建立过滤器
  
+ 队列类型

  在Linux中，可以配置很多类型的队列，如CBQ，HTB等；

  + CBQ比较复杂，不容易理解

  + HTB（HierarchicalToken Bucket）队列

    HTB用于替代CBQ
    
    HTB是一个可分类的队列，与其他复杂的队列类型相比，HTB具有功能强大、配置简单及容易上手等优点

## TC规则

+ 流量控制方式

  + SHAPING(限制)      

    当流量被限制，它的传输速率就被控制在某个值以下。限制值可以大大小于有效带宽，这样可以平滑突发数据流量，使网络更为稳定。shaping（限制）只适用于向外的流量。

  + SCHEDULING(调度)    

    通过调度数据包的传输，可以在带宽范围内，按照优先级分配带宽。SCHEDULING(调度)也只适于向外的流量。

  + POLICING(策略) 

    SHAPING用于处理向外的流量，而POLICIING(策略)用于处理接收到的数据。

  + DROPPING(丢弃) 

    如果流量超过某个设定的带宽，就丢弃数据包，不管是向内还是向外。

+ 流量控制处理对象

  + QDISC(排队规则)

    + QDisc(排队规则)是queueing discipline的简写
+ 无论何时，内核如果需要通过某个网络接口发送数据包，它都需要按照为这个接口配置的qdisc(排队规则)把数据包加入队列。然后，内核会尽可能多地从qdisc里面取出数据包，把它们交给网络适配器驱动模块。
  
    + 最简单的QDisc是pfifo它不对进入的数据包做任何的处理，数据包采用先入先出的方式通过队列。
    
      不过，它会保存网络接口一时无法处理的数据包。

