# LinuxTips27--TC2-TBF队列

1. TBF(令牌桶过滤器)

   + 只允许以不超过事先设定速率到来的数据包通过，但可能允许短暂突发流量超过设定值

2. TBF的实现

   + **缓冲器（桶）**不断地被一些叫做**“令牌“**的虚拟数据以特定速率填充。

   + 桶最重要的参数就是它的大小，也就是它能够存储令牌的数量

   + 每个到来的令牌从数据队列中收集一个数据包，然后从桶中被删除

   + 令牌流和数据流的三种情景

     + 数据流以等于令牌流的速率到达TBF。

       这种情况下，每个到来的数据包都能对应一个令牌，然后无延迟地通过队列

     + 数据流以小于令牌流的速度到达TBF。

       + 这种情况下，通过队列的数据包只消耗了一部分令牌，剩下的令牌会在桶里面累积下来，直到桶被装满。

       + 剩下的令牌可以在需要以高于令牌流速率发送数据包的时候被消耗掉，这种情况下会发生突发传输

     + 数据流以大于令牌流的速率到达TBF。

       + 这种情况下，桶里的令牌很快会被耗尽。导致TBF中断一段时间，称为**“越限”**。如果数据包持续到来，将会发生丢包

       + 这种情况非常重要，因为它可以用来对数据通过过滤器的速率进行整形。
         + 令牌的累积可以导致越限的数据包进行短时间的突发传输而不必丢包
         + 但是持续越限会导致传输延迟直至丢包

   + 实际的实现是针对数据的字节数进行的，而不是数据包进行

3. TBF参数

   + limit/latency

     + 永远可用

     + limit确定最多有多少数据（字节数）在队列中等待可用令牌

       也可以通过设置latency参数来指定这个参数

     + latency参数确定了一个包在TBF中等待传输的最长等待时间
     
     + 后者计算决定桶的大小、速率和峰值速率==?==
     
   + burst/buffer/maxburst
   
     + 桶的大小，以字节计算
     + 这个参数制定了最多可以有多少个令牌能够立即被使用。
     + 通常情况下，管理的带宽越大，需要的缓冲器就越大。
     + 如果缓冲器太小，就会导致到达的令牌没有地方放（桶满了），这会导致潜在的丢包
   
   + mpu(Minimum Packet Unit，最小分组单位)
   
     + 一个零长度的包并不是不耗费带宽。
   
       例如，以太网数据帧不会小于64字节。
   
     + mpu决定了令牌的最低消耗
   
   + rate
   
     + 速度操纵杆
   
     + 如果通存在令牌而且运行没有令牌，这相当于不限制速率。
   
     + 如果希望限制速率，需要调整以下参数
   
       + peakrate
   
         + 峰值速率可以用来指定令牌以多快的速度被删除
   
           即，释放一个数据包，然后等待足够的时间后再释放下一个。通过计算等待时间来控制峰值速率
   
           然而，由于UNIX定时器的分辨率是10毫秒，如果平均包长为10kbit，峰值速率则被限制在1Mbps==?==
   
       + mtu/minburst==?==
   
         + 如果常规速率比较高，1Mbps 的峰值速率就没有什么价值。
   
         + 要实现更高的峰值速率，可以在一个时钟周期内发送多个数据包。最有效的办法就是再创建一个令牌桶。这第二个令牌桶缺省情况下为一个单个的数据包，并非一个真正的桶。要计算峰值速率，用 mtu 乘以 100 就行了。
   
       