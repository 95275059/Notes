# Blockchain5--Merkle树

1. Merkle Tree(默克尔树)（Hash Tree）

   + 结构

     ![Blockchain5-1](E:\Notes\Blockchain\Blockchain5-1.png)

     + 叶子结点上的值通常是数据块的哈希值

   + 构造过程

     + 对数据块计算哈希值
       + 通常选用SHA-256等哈希算法
       + 但如果仅仅防止数据不是蓄意的损坏或篡改，可以改用一些安全性低但是效率高的校验和算法，如CRC
     + 将数据块计算的哈希值两两配对
       + 如果是奇数个数，最后一个自己与自己配对
     + 计算上一层哈希
     + 重复上面步骤，一直到计算出根哈希值

2. 作用

   + 大多用来进行完整性验证
     + 例如，分布式环境下，从多台主机获取数据时，只要验证Merkle树根哈希一致，即可验证获取的数据是正确的
       + 例如，上图中L3数据块发生错误（或被篡改）
         + 错误会传导到计算hash(L3)
         + 接着传导到计算hash(Hash1-0+Hash1-1)
         + 最后传导到根哈希，导致根哈希的不一致
     + 即，任何底层数据块的变化，最终都会传导到根哈希
     + 同时，如果根哈希不一致，也可以通过Merkle树快速定位到导致不一致的数据
   + 对数据进行快速比对，快速定位不一致的数据
     + 例如，分布式存储中，一份数据会有多个副本，并且分布在不同的机器上
       + 为了保持数据一致性，需要进行副本同步
       + 而首要的就是比对当前副本是否一致
         + 如果一致，则无需同步；如果不一致，还需找出不一致的地方，然后进行同步
         + 如果采用直接传输数据进行比对，非常低效
         + 一般采用对数据进行哈希，传输哈希值进行对比的方法
       + 可以对每台机器需要比对的数据构造Merkle树
         + 如果根哈希一致，则数据相同；如果根哈希不一致，则通过Merkle树快速检索到不一致的数据
     + 以结构图为例，假设两台机器中L3数据块不一致
       + 对比根哈希，发现根哈希不一致；即数据不一致
       + 对比Hash0和Hash1，发现Hash1不一致
       + 接着向下发现是Hash1-0不一致，这样就定位到是L3数据块不一致。
     + 定位过程的算法复杂度为O(log(n))

3. Hash list

   + 在一定程度上可以看做是Merkle树的子树，但又不完全一样
   + 在点对点网络中数据传输的时候，为了提高效率往往会同时从多个机器下载数据的不同部分，即，不是从一台机器下载整个数据，而是将完整数据分成不同的部分，分别同时从不同的机器获取完整数据的不同组成部分。这样分块传输不但可以同时从多台机器下载数据，另一个好处是如果这一小块数据传输过程中损坏了，只要重新下载这一小数据块就可以了，不用重新下载整个数据
   + 但这种分布式环境下，很多机器应该认为是不稳定或者不可信的，如何校验整个数据的完整性及每一小数据块的完整性呢？
     + 为了校验每个数据块，我们需要对每个数据块做哈希，形成一个哈希列表
       + 这样进行下载前，先获取一个哈希列表
       + 下载后，就可以通过哈希列表，来验证每个数据块
   + 如何保证这个哈希列表是正确的呢，或者说怎么校验完整数据呢？
     + 只要每一个数据块哈希是正确的，最终获取的完整数据就一定是正确的
     + 对哈希列表进行哈希得到根哈希
     + 将此根哈希放到一个可信源中
     + 在下载数据前，先从可信数据源哪里获取到数据的跟哈希
     + 然后从任意机器获取哈希列表
     + 再下载数据块
     + 这样，数据完整性可以通过根哈希来保证

4. Merkle Tree与Hash list对比

   + 两种数据结构都有验证数据完整性的功能，都可以通过根哈希保证整体数据完整性
   + 不同的是，在数据庞大，数据块非常多的情况下，当根哈希检测到数据不一致时
     + Merkle tree可以快速的定位到导致不一致的数据块，复杂度为O(log(n))
     + Hash list只能遍历庞大的哈希列表定位到导致不一致的数据块，复杂度为O(n)
     + 很显然，此时Merkle tree的效率要高很多。

   

   